#!/bin/bash
# Download PyPy for glibc systems (Debian, Ubuntu, Fedora, etc.)
# Usage: ./download-pypy [version]

BASE_URL="https://downloads.python.org/pypy"
REQ_VERSION="${1:-latest}"

if [ "$REQ_VERSION" = "latest" ]; then
  FILENAME=$(curl -sSL --compressed "$BASE_URL/" \
    | grep -oE 'pypy3\.[0-9]+-v[0-9.]+-linux64\.tar\.bz2' \
    | sort -uV \
    | tail -1)
else
  FILENAME=$(curl -sSL --compressed "$BASE_URL/" \
    | grep -oE "pypy3\.[0-9]+-${REQ_VERSION}-linux64\.tar\.bz2" \
    | sort -uV \
    | tail -1)
fi

if [ -z "$FILENAME" ]; then
  echo "Error: Could not find PyPy version '$REQ_VERSION'"
  exit 1
fi

VERSION="${FILENAME%%.tar.bz2}"

if [ -d "$VERSION" ]; then
  echo "Already installed: $VERSION"
else
  echo "Downloading $FILENAME..."
  curl -sSL -O "$BASE_URL/$FILENAME"
  echo "Extracting to $VERSION..."
  mkdir -p "$VERSION"
  tar xf "$FILENAME" --strip-components=1 -C "$VERSION"
  rm "$FILENAME"
fi

# Add to PATH hint
echo "Add to PATH: export PATH=\"\$PWD/$VERSION/bin:\$PATH\""
echo "Then run: ./setup"
